{% extends "BenLogementBundle::layout.html.twig" %}
{% block title %}
Tableau de bord | {{ parent() }}
{% endblock %}
{% block body %}

 <h3><span class="glyphicon glyphicon-user"></span> {% if status == 'résidant' %}Liste des étudiants résidents{% else  %}Gestion des etudiants{% endif %}</h3>
    <form  id="jsForm" role="form" method="post" action="">
          <input id="pagenumber" type="hidden" name="page" value="1"> 
          <input type="hidden" name="template" value="ajax_list"> 
          <input id="status" type="hidden" name="status" value="{{ status }}"> 
            <div class="row hide-print">
              <div class="col-md-5 form-group">
                <div class="input-group">
                  <input type="text" name="keyword" class="form-control" placeholder="Search">
                  <div class="input-group-btn">
                  <button class="btn btn-default" type="button"><span class="glyphicon glyphicon-search"></span></button>
                  </div><!-- /btn-group -->
                </div><!-- /input-group -->
              </div><!-- /.col-md-6 -->

              <div class="col-md-3">
                <select id="js-type" name="type" class="form-control">
                    <option value="all">Filtrer par</option>
                    <option value="{{ person.new }}">Nouveaux étudiants</option>
                    <option value="{{ person.old }}">Anciens étudiants</option>
                    <option value="{{ person.foreign }}">Etudiants étrangers</option>
                    <option value="{{ person.special }}">Etudiants en situation particulière</option>
                </select>
              </div><!-- /.col-md-3 -->

              <div class="col-lg-2">
              <div class="col-md-9">
              <select id="js-perpage" name="perpage" class="form-control">
                <option value="10" {% if app_config.rows_per_page == 10 %}selected{% endif %}>10</option>
                <option value="20" {% if app_config.rows_per_page == 20 %}selected{% endif %}>20</option>
                <option value="50" {% if app_config.rows_per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if app_config.rows_per_page == 100 %}selected{% endif %}>100</option>
              </select>
              </div>
              </div>

              <div class="col-md-2">
                <div class="btn-group pull-right">              
                  <button class="btn btn-primary "><span class="glyphicon glyphicon-cog"></span> Action</button>
                  <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                    <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu">
                    <li><a href="{{ path('etudiant_new') }}"><span class="glyphicon glyphicon-plus"></span> Ajouter ({{person.new}})</a></li>
                    <li><a href="{{ path('etudiant_new', {type: person.foreign}) }}"><span class="glyphicon glyphicon-plus"></span> Ajouter ({{person.foreign}})</a></li>
                    <li><a href="{{ path('etudiant_new', {type: person.special}) }}"><span class="glyphicon glyphicon-plus"></span> Ajouter ({{person.special}})</a></li>
                    <li><a href="#"  data-toggle="modal" data-target="#searchModal"><span class="glyphicon glyphicon-search"></span> Recherche avancée</a></li>
                {% if status == 'résidant' %}
                    <li><a href="#" class="js-reject"><span class="glyphicon glyphicon-ban-circle"></span> Rejeter</a></li>
                    <li><a href="#" id="js-switch"><span class="glyphicon glyphicon-resize-small"></span> Changement de chambre</a></li>
                {% else %}
                    <li><a href="#" class="js-enable" data-action="non valide"><span class="glyphicon glyphicon-ban-circle"></span> Rejeter</a></li>
                {% endif %}
                    <li class="divider"></li>
                    <li><a href="#" id="btnApprouver"><span class="glyphicon glyphicon-export"></span> Exporter</a></li>
                      <li><a id="btnPrint"><span class="glyphicon glyphicon-print"></span> imprimer</a></li>
                    <li><a href="#" id="btnSupprimer"><span class="glyphicon glyphicon-trash"></span> Supprimer</a></li>
                  </ul>
                </div>
              </div>
            </div><!-- /.row -->

            <table class="table table-striped table-hover table-bordered">
                <thead>
                    <tr>
                        <th class="hide-print"><input type="checkbox" value=""></th>
                        <th>Dossier</th>
                        <th>Nom</th>
                        <th>Email</th>
                        <th>CIN</th>
                        <th>CNE</th>
                        <th>Etat</th>
                        <th>Type</th>
                        <th class="hide-print">action</th>
                    </tr>
                </thead>
                <tbody id="dataContainer">
                    
                </tbody>
            </table>
        <div class="caption">
          <strong>Total:</strong> <em>{{ entitiesLength }} Etudiants</em>
        </div>
{% include "BenLogementBundle:Person:search.html.twig" %}
</form>

{% endblock body %}
{% block javascripts %}
{{ parent() }}
<script> 
    (function($) {

      /* profile navigation */
      var form = $('#jsForm'),
          dataContainer = form.find('#dataContainer'),
          pageInput = form.find('#pagenumber'),
          typeInput = form.find('#js-type'),
          perPageBtn = form.find('#js-perpage'),
          enableBtn = form.find('.js-enable'),
          rejectBtn = form.find('.js-reject'),
          searchBtn = form.find('#js-search'),
          switchBtn = form.find('#js-switch'),
          closeBtn = $('#searchModal').find('.close'),
          jsFormUrl = '',
          checkboxBtn = form.find("input:checkbox"),
          infomodal = $('#infoModal'),
          modalBody = infomodal.find('.modal-body'),
          index=0;

      function init(){
        pageInput.val('1');
        // checkboxBtn.prop("checked",false);
        jsFormUrl = '{{ path('etudiant_ajax') }}';
      }
      function ajaxPost(action) {
        console.log(form.serialize());
        form.addClass('working');
        $.ajax({ 
          type: "POST", 
          data: form.serialize(),
          url: jsFormUrl, 
          success: function(data){ 
            form.removeClass('working');
            init();
            if(!action)
                dataContainer.empty().hide().html(data).fadeIn();
            else ajaxPost();
          },
          error:function(){
              alert('service denied');
              form.removeClass('working');
          }
        });
        return false;
      }
      
      /* enable or disable a user*/
      enableBtn.on('click', function(){
        var url = '{{ path('etudiant_status', {'status': 1111 }) }}',
            etat = $(this).data('action');
        jsFormUrl = url.replace("1111", etat);
        ajaxPost('enable');
      });
      /* reject a user */
      rejectBtn.on('click', function(){
        jsFormUrl = '{{ path('etudiant_cancel') }}';
        ajaxPost('reject');
      });

      /* pagination */    
      form.on('click', '.js-page', function(){
          pageInput.val($(this).data('page'));
          ajaxPost();
      });

      /* number of rows per page */
      perPageBtn.on('change', ajaxPost);
      typeInput.on('change', ajaxPost);
      searchBtn.on('click', function () {
        closeBtn.trigger('click');
          ajaxPost();
      });

      /* switch rooms */
      switchBtn.on('click', function(){
        if (dataContainer.find('input:checkbox:checked').length != 2) {
          alert('vous devez selectionner deux etudiants');
          return false;
        };
        jsFormUrl='{{ path('room_switch') }}';
        ajaxPost('switch');
      });

      form.on('submit', ajaxPost);

      /* submit the form after loading the page*/
      init();
      setTimeout(ajaxPost, 1);

    })(jQuery);
</script>
{% endblock %}
